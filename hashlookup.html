<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <h1>crushabuse</h1>
    <h2>Tips</h2>
    <ul>
      <li>People don't usually include middle names</li>
      <li>Don't add any white space</li>
      <li>If you have a hypenated name, try it without the second part</li>
      <li>You can also try just your first name, or a nickname.</li>
    </ul>
    <input placeholder="What's your name?" id="champ" />
    <button onclick="example()">Look it up</button>
    <h2>List of crushes found</h2>
    <div id="crushes">
      <ul id="james"></ul>
    </div>
    <footer>
      <script>
        var urlParams = new URLSearchParams(window.location.search);
        var name = urlParams.get("name");
        if (name && name != "null") {
          document.querySelector("#champ").value = name;
          example();
        }
        if (window.location.hash.substring(1))
          document.querySelector("#champ").value = decodeURIComponent(
            window.location.hash.substring(1)
          );
        async function sha256(message) {
          // encode as UTF-8
          const msgBuffer = new TextEncoder().encode(message);

          // hash the message
          const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);

          // convert ArrayBuffer to Array
          const hashArray = Array.from(new Uint8Array(hashBuffer));

          // convert bytes to hex string
          const hashHex = hashArray
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
          return hashHex;
        }
        async function example() {
          document.getElementById("james").innerHTML =
            "Loading... Please wait...";
          var hash = "";
          if (
            /\b[A-Fa-f0-9]{64}\b/.test(document.getElementById("champ").value)
          ) {
            hash = document
              .getElementById("champ")
              .value.toLowerCase()
              .toString();
          } else {
            hash = await sha256(
              document.getElementById("champ").value.toLowerCase().toString()
            );
          }

          fetch("https://crushabuse.glitch.me/api/check/" + hash)
            .then((chungus) => chungus.json())
            .then((chungus) => {
              document.getElementById("james").innerHTML = "";
              if (chungus.length == 0)
                document.getElementById("james").innerHTML =
                  "sorry, no results found for " +
                  document.getElementById("champ").value;
              chungus.forEach((chung) => {
                document.getElementById("james").innerHTML += `<li><a href="${
                  chung.permalink
                }">${chung.permalink}</a> (posted ${new Date(
                  chung.date * 1000
                ).toLocaleString("en-US", {
                  timeStyle: "short",
                  dateStyle: "long",
                })})</li>`;
              });
            });
        }
      </script>
    </footer>
  </body>
</html>
